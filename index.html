<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Optimizaci√≥n de Cupos GAD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #444;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .database-card {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .database-card:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }

        .database-card.loaded {
            border: 2px solid #10b981;
            background: #ecfdf5;
        }

        .database-card h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .database-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-loaded {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        .progress-container {
            margin: 20px 0;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step.active::before {
            background: #667eea;
        }

        .step.completed::before {
            background: #10b981;
        }

        .step span {
            display: block;
            margin-top: 50px;
            font-size: 0.9rem;
            color: #666;
        }

        .data-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
            color: #374151;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .result-card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .result-card h4 {
            color: #374151;
            margin-bottom: 15px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-weight: 600;
            color: #667eea;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .tab-container {
            margin: 20px 0;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .gad-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .gad-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .gad-info h5 {
            color: #374151;
            margin-bottom: 5px;
        }

        .gad-info p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .gad-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-optimized {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-problematic {
            background: #fee2e2;
            color: #dc2626;
        }

        .floating-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .floating-buttons {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèõÔ∏è Sistema de Optimizaci√≥n de Cupos GAD</h1>
            <p class="subtitle">An√°lisis financiero inteligente para Gobiernos Aut√≥nomos Descentralizados</p>
        </div>

        <!-- Indicador de Pasos -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <span>1. Cargar Datos</span>
            </div>
            <div class="step" id="step2">
                <span>2. Validar</span>
            </div>
            <div class="step" id="step3">
                <span>3. Procesar</span>
            </div>
            <div class="step" id="step4">
                <span>4. Optimizar</span>
            </div>
            <div class="step" id="step5">
                <span>5. Reportes</span>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Sidebar de Carga de Datos -->
            <div class="sidebar">
                <h2 class="section-title">üìä Bases de Datos Requeridas</h2>
                
                <div class="database-card" data-db="gastos">
                    <div class="status-badge status-pending">Pendiente</div>
                    <h3>üè¶ Datos Completos de Gastos</h3>
                    <p>Proyecciones financieras y presupuestarias de los GADs</p>
                    <input type="file" class="file-input" accept=".xlsx,.xls,.csv" 
                           onchange="loadDatabase('gastos', this)">
                </div>

                <div class="database-card" data-db="rankings">
                    <div class="status-badge status-pending">Pendiente</div>
                    <h3>üìà Rankings AT</h3>
                    <p>Rankings y deciles de desempe√±o de GADs</p>
                    <input type="file" class="file-input" accept=".xlsx,.xls,.csv,.dta" 
                           onchange="loadDatabase('rankings', this)">
                </div>

                <div class="database-card" data-db="equidad">
                    <div class="status-badge status-pending">Pendiente</div>
                    <h3>‚öñÔ∏è Modelo de Equidad Municipal</h3>
                    <p>Datos de equidad del Ministerio de Econom√≠a y Finanzas</p>
                    <input type="file" class="file-input" accept=".xlsx,.xls,.csv" 
                           onchange="loadDatabase('equidad', this)">
                </div>

                <div class="database-card" data-db="deuda">
                    <div class="status-badge status-pending">Pendiente</div>
                    <h3>üí≥ Datos de Deuda</h3>
                    <p>Informaci√≥n hist√≥rica y proyectada de endeudamiento</p>
                    <input type="file" class="file-input" accept=".xlsx,.xls,.csv" 
                           onchange="loadDatabase('deuda', this)">
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn" onclick="validateAllData()" id="validateBtn" disabled>
                        <span class="loading-spinner hidden" id="validateSpinner"></span>
                        üîç Validar Datos
                    </button>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <p style="text-align: center; font-size: 0.9rem; color: #666; margin-top: 10px;">
                    <span id="progressText">0/4 bases cargadas</span>
                </p>
            </div>

            <!-- √Årea de Contenido Principal -->
            <div class="content-area">
                <!-- Pesta√±a de Vista Previa de Datos -->
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('preview')">üëÅÔ∏è Vista Previa</button>
                        <button class="tab-button" onclick="showTab('validation')">‚úÖ Validaci√≥n</button>
                        <button class="tab-button" onclick="showTab('processing')">‚öôÔ∏è Procesamiento</button>
                        <button class="tab-button" onclick="showTab('results')">üìä Resultados</button>
                    </div>

                    <!-- Contenido de Vista Previa -->
                    <div class="tab-content active" id="preview-tab">
                        <h3 class="section-title">Vista Previa de Datos</h3>
                        <div id="data-preview-container">
                            <div class="alert alert-warning">
                                üì• Por favor, carga las bases de datos para ver la vista previa
                            </div>
                        </div>
                    </div>

                    <!-- Contenido de Validaci√≥n -->
                    <div class="tab-content" id="validation-tab">
                        <h3 class="section-title">Validaci√≥n de Integridad</h3>
                        <div id="validation-results">
                            <div class="alert alert-warning">
                                ‚è≥ Carga y valida los datos para ver los resultados de integridad
                            </div>
                        </div>
                    </div>

                    <!-- Contenido de Procesamiento -->
                    <div class="tab-content" id="processing-tab">
                        <h3 class="section-title">Configuraci√≥n y Procesamiento</h3>
                        
                        <div class="results-grid">
                            <div class="result-card">
                                <h4>‚öôÔ∏è Par√°metros de Optimizaci√≥n</h4>
                                <div style="margin: 15px 0;">
                                    <label for="precision">Precisi√≥n de Optimizaci√≥n:</label>
                                    <input type="number" id="precision" value="0.01" step="0.001" min="0.001" max="0.1"
                                           style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
                                </div>
                                <div style="margin: 15px 0;">
                                    <label for="strategy">Estrategia de Optimizaci√≥n:</label>
                                    <select id="strategy" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px;">
                                        <option value="automatic">Autom√°tica (Recomendado)</option>
                                        <option value="conservative">Conservadora</option>
                                        <option value="aggressive">Agresiva</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" onclick="startProcessing()" id="processBtn" disabled>
                                    üöÄ Iniciar Procesamiento
                                </button>
                            </div>

                            <div class="result-card">
                                <h4>üìà Estado del Sistema</h4>
                                <div class="metric">
                                    <span>GADs Detectados:</span>
                                    <span class="metric-value" id="gadsCount">0</span>
                                </div>
                                <div class="metric">
                                    <span>A√±os de Datos:</span>
                                    <span class="metric-value" id="yearsRange">-</span>
                                </div>
                                <div class="metric">
                                    <span>Registros Totales:</span>
                                    <span class="metric-value" id="totalRecords">0</span>
                                </div>
                                <div class="metric">
                                    <span>Estado:</span>
                                    <span class="metric-value" id="systemStatus">Esperando datos</span>
                                </div>
                            </div>
                        </div>

                        <div id="processing-log" class="data-preview hidden">
                            <h4>üìã Log de Procesamiento</h4>
                            <div id="log-content" style="background: #1f2937; color: #10b981; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">
                                Sistema listo para procesamiento...
                            </div>
                        </div>
                    </div>

                    <!-- Contenido de Resultados -->
                    <div class="tab-content" id="results-tab">
                        <h3 class="section-title">Resultados de Optimizaci√≥n</h3>
                        <div id="optimization-results">
                            <div class="alert alert-warning">
                                ‚è≥ Ejecuta el procesamiento para ver los resultados de optimizaci√≥n
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones Flotantes -->
    <div class="floating-buttons">
        <button class="floating-btn" onclick="downloadReport()" title="Descargar Reporte" id="downloadBtn" style="display: none;">
            üìÑ
        </button>
        <button class="floating-btn" onclick="resetSystem()" title="Reiniciar Sistema">
            üîÑ
        </button>
        <button class="floating-btn" onclick="showHelp()" title="Ayuda">
            ‚ùì
        </button>
    </div>

    <script>
        // Estado global del sistema
        let systemState = {
            databases: {
                gastos: null,
                rankings: null,
                equidad: null,
                deuda: null
            },
            loadedCount: 0,
            validationResults: null,
            processingResults: null,
            optimizationResults: null
        };

        // Configuraci√≥n de las bases de datos
        const databaseConfig = {
            gastos: {
                name: "Datos Completos de Gastos",
                requiredColumns: ["gad", "anho", "ing_pred", "g1_pred", "g2_pred", "est1"],
                description: "Proyecciones financieras de GADs"
            },
            rankings: {
                name: "Rankings AT",
                requiredColumns: ["gad", "DECIL"],
                description: "Rankings y deciles de GADs"
            },
            equidad: {
                name: "Modelo de Equidad Municipal",
                requiredColumns: ["gad"],
                description: "Datos de equidad del MEF"
            },
            deuda: {
                name: "Datos de Deuda",
                requiredColumns: ["gad", "anho", "serv_deuda_total", "deuda_total"],
                description: "Informaci√≥n de endeudamiento"
            }
        };

        // Cargar base de datos
        async function loadDatabase(dbType, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            showLoading(`Cargando ${databaseConfig[dbType].name}...`);

            try {
                const data = await parseFile(file);
                
                // Validar columnas requeridas
                if (data.length === 0) {
                    throw new Error("El archivo est√° vac√≠o");
                }

                const columns = Object.keys(data[0]);
                const requiredColumns = databaseConfig[dbType].requiredColumns;
                const missingColumns = requiredColumns.filter(col => !columns.includes(col));

                if (missingColumns.length > 0) {
                    throw new Error(`Faltan columnas requeridas: ${missingColumns.join(', ')}`);
                }

                // Guardar datos
                systemState.databases[dbType] = data;
                
                // Actualizar UI
                updateDatabaseCard(dbType, 'loaded', data.length);
                updateProgress();
                showPreview(dbType, data);

                logMessage(`‚úÖ ${databaseConfig[dbType].name} cargada: ${data.length} registros`);

            } catch (error) {
                updateDatabaseCard(dbType, 'error', 0);
                showAlert(`Error cargando ${databaseConfig[dbType].name}: ${error.message}`, 'error');
                logMessage(`‚ùå Error: ${error.message}`);
            }
        }

        // Parsear archivo (simulado - en implementaci√≥n real usar√≠as librer√≠as como Papa Parse)
        async function parseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        
                        if (file.name.endsWith('.csv')) {
                            resolve(parseCSV(text));
                        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            // En implementaci√≥n real usar√≠as SheetJS
                            resolve(parseCSV(text)); // Simulado como CSV
                        } else {
                            reject(new Error('Formato de archivo no soportado'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Error leyendo el archivo'));
                reader.readAsText(file);
            });
        }

        // Parser CSV simple
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    let value = values[index]?.trim() || '';
                    
                    // Convertir n√∫meros
                    if (!isNaN(value) && value !== '') {
                        value = parseFloat(value);
                    }
                    
                    obj[header] = value;
                });
                return obj;
            });
        }

        // Actualizar tarjeta de base de datos
        function updateDatabaseCard(dbType, status, recordCount) {
            const card = document.querySelector(`[data-db="${dbType}"]`);
            const badge = card.querySelector('.status-badge');
            
            badge.className = `status-badge status-${status}`;
            
            switch (status) {
                case 'loaded':
                    badge.textContent = `‚úÖ ${recordCount} registros`;
                    card.classList.add('loaded');
                    systemState.loadedCount++;
                    break;
                case 'error':
                    badge.textContent = '‚ùå Error';
                    card.classList.remove('loaded');
                    break;
                default:
                    badge.textContent = 'Pendiente';
                    card.classList.remove('loaded');
            }

            // Habilitar bot√≥n de validaci√≥n si todas las bases est√°n cargadas
            if (systemState.loadedCount === 4) {
                document.getElementById('validateBtn').disabled = false;
                updateStep(2, 'active');
            }
        }

        // Actualizar progreso
        function updateProgress() {
            const progress = (systemState.loadedCount / 4) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${systemState.loadedCount}/4 bases cargadas`;
        }

        // Mostrar vista previa
        function showPreview(dbType, data) {
            const container = document.getElementById('data-preview-container');
            
            if (systemState.loadedCount === 1) {
                container.innerHTML = ''; // Limpiar mensaje inicial
            }

            const previewDiv = document.createElement('div');
            previewDiv.className = 'data-preview';
            
            const preview = data.slice(0, 5); // Primeros 5 registros
            const columns = Object.keys(preview[0]);

            previewDiv.innerHTML = `
                <h4>üìä ${databaseConfig[dbType].name}</h4>
                <p><strong>Registros:</strong> ${data.length} | <strong>Columnas:</strong> ${columns.length}</p>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${preview.map(row => 
                                `<tr>${columns.map(col => `<td>${row[col]}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                ${data.length > 5 ? `<p style="margin-top: 10px; color: #666; font-size: 0.9rem;">... y ${data.length - 5} registros m√°s</p>` : ''}
            `;

            container.appendChild(previewDiv);
        }

        // Validar todos los datos
        async function validateAllData() {
            if (systemState.loadedCount < 4) {
                showAlert('Por favor carga todas las bases de datos primero', 'warning');
                return;
            }

            showLoading('Validando integridad de datos...');
            document.getElementById('validateBtn').disabled = true;

            try {
                // Simular validaci√≥n (en implementaci√≥n real ser√≠a m√°s compleja)
                await new Promise(resolve => setTimeout(resolve, 2000));

                const validationResults = performDataValidation();
                systemState.validationResults = validationResults;

                displayValidationResults(validationResults);
                
                if (validationResults.isValid) {
                    updateStep(2, 'completed');
                    updateStep(3, 'active');
                    document.getElementById('processBtn').disabled = false;
                    showAlert('‚úÖ Validaci√≥n exitosa. Los datos est√°n listos para procesamiento.', 'success');
                    updateSystemStats();
                } else {
                    showAlert('‚ö†Ô∏è Se encontraron problemas en la validaci√≥n. Revisa los detalles.', 'warning');
                }

                logMessage('üîç Validaci√≥n de datos completada');

            } catch (error) {
                showAlert(`Error durante la validaci√≥n: ${error.message}`, 'error');
                logMessage(`‚ùå Error en validaci√≥n: ${error.message}`);
            } finally {
                document.getElementById('validateBtn').disabled = false;
            }
        }

        // Realizar validaci√≥n de datos
        function performDataValidation() {
            const results = {
                isValid: true,
                errors: [],
                warnings: [],
                stats: {}
            };

            try {
                // Validar consistencia de GADs
                const gadsGastos = new Set(systemState.databases.gastos.map(row => row.gad));
                const gadsDeuda = new Set(systemState.databases.deuda.map(row => row.gad));
                const gadsRankings = new Set(systemState.databases.rankings.map(row => row.gad));

                // GADs faltantes
                const faltantesDeuda = [...gadsGastos].filter(gad => !gadsDeuda.has(gad));
                const faltantesRankings = [...gadsGastos].filter(gad => !gadsRankings.has(gad));

                if (faltantesDeuda.length > 0) {
                    results.warnings.push(`${faltantesDeuda.length} GADs sin datos de deuda`);
                }

                if (faltantesRankings.length > 0) {
                    results.warnings.push(`${faltantesRankings.length} GADs sin rankings`);
                }

                // Validar rangos num√©ricos
                const invalidIngresos = systemState.databases.gastos.filter(row => 
                    typeof row.ing_pred === 'number' && row.ing_pred <= 0
                ).length;

                if (invalidIngresos > 0) {
                    results.errors.push(`${invalidIngresos} registros con ingresos inv√°lidos`);
                    results.isValid = false;
                }

                // Validar estratos
                const invalidEstratos = systemState.databases.gastos.filter(row => 
                    typeof row.est1 === 'number' && (row.est1 < 1 || row.est1 > 6)
                ).length;

                if (invalidEstratos > 0) {
                    results.errors.push(`${invalidEstratos} registros con estratos inv√°lidos`);
                    results.isValid = false;
                }

                // Estad√≠sticas
                results.stats = {
                    totalGADs: gadsGastos.size,
                    totalRegistros: systemState.databases.gastos.length,
                    a√±osRango: getYearRange(systemState.databases.gastos),
                    estratosDistribucion: getEstratoDistribution(systemState.databases.gastos)
                };

            } catch (error) {
                results.errors.push(`Error durante validaci√≥n: ${error.message}`);
                results.isValid = false;
            }

            return results;
        }

        // Obtener rango de a√±os
        function getYearRange(data) {
            const a√±os = data.map(row => row.anho).filter(a√±o => typeof a√±o === 'number');
            if (a√±os.length === 0) return 'N/A';
            return `${Math.min(...a√±os)} - ${Math.max(...a√±os)}`;
        }

        // Obtener distribuci√≥n de estratos
        function getEstratoDistribution(data) {
            const distribution = {};
            data.forEach(row => {
                if (typeof row.est1 === 'number') {
                    distribution[row.est1] = (distribution[row.est1] || 0) + 1;
                }
            });
            return distribution;
        }

        // Mostrar resultados de validaci√≥n
        function displayValidationResults(results) {
            const container = document.getElementById('validation-results');
            
            let html = '';

            // Resumen general
            html += `
                <div class="alert ${results.isValid ? 'alert-success' : 'alert-error'}">
                    ${results.isValid ? '‚úÖ Validaci√≥n exitosa' : '‚ùå Problemas encontrados en la validaci√≥n'}
                </div>
            `;

            // Estad√≠sticas
            html += `
                <div class="results-grid">
                    <div class="result-card">
                        <h4>üìä Estad√≠sticas Generales</h4>
                        <div class="metric">
                            <span>Total GADs:</span>
                            <span class="metric-value">${results.stats.totalGADs}</span>
                        </div>
                        <div class="metric">
                            <span>Total Registros:</span>
                            <span class="metric-value">${results.stats.totalRegistros}</span>
                        </div>
                        <div class="metric">
                            <span>Rango de A√±os:</span>
                            <span class="metric-value">${results.stats.a√±osRango}</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üèõÔ∏è Distribuci√≥n por Estratos</h4>
                        ${Object.entries(results.stats.estratosDistribucion).map(([estrato, count]) => `
                            <div class="metric">
                                <span>Estrato ${estrato}:</span>
                                <span class="metric-value">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Errores
            if (results.errors.length > 0) {
                html += `
                    <div class="alert alert-error">
                        <h4>‚ùå Errores Encontrados:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${results.errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Advertencias
            if (results.warnings.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <h4>‚ö†Ô∏è Advertencias:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            ${results.warnings.map(warning => `<li>${warning}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            container.innerHTML = html;
            showTab('validation');
        }

        // Actualizar estad√≠sticas del sistema
        function updateSystemStats() {
            if (systemState.validationResults) {
                document.getElementById('gadsCount').textContent = systemState.validationResults.stats.totalGADs;
                document.getElementById('yearsRange').textContent = systemState.validationResults.stats.a√±osRango;
                document.getElementById('totalRecords').textContent = systemState.validationResults.stats.totalRegistros;
                document.getElementById('systemStatus').textContent = 'Listo para procesar';
            }
        }

        // Iniciar procesamiento
        async function startProcessing() {
            if (!systemState.validationResults || !systemState.validationResults.isValid) {
                showAlert('Por favor valida los datos primero', 'warning');
                return;
            }

            const precision = parseFloat(document.getElementById('precision').value);
            const strategy = document.getElementById('strategy').value;

            showLoading('Iniciando procesamiento y optimizaci√≥n...');
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processing-log').classList.remove('hidden');

            try {
                // Paso 1: Procesamiento de datos
                updateStep(3, 'completed');
                updateStep(4, 'active');
                logMessage('üîÑ Iniciando procesamiento de datos...');
                
                await simulateProcessing('Consolidando datos de GADs...', 1000);
                logMessage('‚úÖ Datos consolidados exitosamente');

                await simulateProcessing('Calculando par√°metros financieros...', 1500);
                logMessage('‚úÖ Par√°metros calculados');

                await simulateProcessing('Aplicando restricciones COPLAFIP...', 1200);
                logMessage('‚úÖ Restricciones aplicadas');

                // Paso 2: Optimizaci√≥n
                logMessage('üéØ Iniciando optimizaci√≥n autom√°tica...');
                await simulateProcessing('Detectando GADs problem√°ticos...', 800);
                
                const gadsProblematicos = Math.floor(systemState.validationResults.stats.totalGADs * 0.3);
                logMessage(`üìä ${gadsProblematicos} GADs problem√°ticos detectados`);

                await simulateProcessing('Optimizando par√°metros por estrato...', 2000);
                logMessage('‚öôÔ∏è Optimizaci√≥n por estratos completada');

                await simulateProcessing('Validando resultados...', 1000);
                logMessage('‚úÖ Validaci√≥n de resultados exitosa');

                // Generar resultados simulados
                const optimizationResults = generateOptimizationResults(gadsProblematicos);
                systemState.optimizationResults = optimizationResults;

                // Mostrar resultados
                displayOptimizationResults(optimizationResults);
                
                updateStep(4, 'completed');
                updateStep(5, 'active');
                
                document.getElementById('downloadBtn').style.display = 'block';
                showAlert('üéâ Optimizaci√≥n completada exitosamente!', 'success');
                logMessage('üéØ Proceso de optimizaci√≥n finalizado');

            } catch (error) {
                showAlert(`Error durante el procesamiento: ${error.message}`, 'error');
                logMessage(`‚ùå Error: ${error.message}`);
            } finally {
                document.getElementById('processBtn').disabled = false;
            }
        }

        // Simular procesamiento
        async function simulateProcessing(message, duration) {
            logMessage(`‚è≥ ${message}`);
            await new Promise(resolve => setTimeout(resolve, duration));
        }

        // Generar resultados de optimizaci√≥n simulados
        function generateOptimizationResults(gadsProblematicos) {
            const totalGads = systemState.validationResults.stats.totalGADs;
            const optimizados = Math.floor(gadsProblematicos * 0.75);
            const noOptimizables = gadsProblematicos - optimizados;

            return {
                totalProcesados: gadsProblematicos,
                optimizados: optimizados,
                noOptimizables: noOptimizables,
                tasaExito: (optimizados / gadsProblematicos * 100).toFixed(1),
                reduccionPromedio: (Math.random() * 30 + 10).toFixed(2),
                detallesPorEstrato: generateEstratoDetails(),
                topOptimizaciones: generateTopOptimizations(5),
                gadsProblematicosRestantes: noOptimizables
            };
        }

        // Generar detalles por estrato
        function generateEstratoDetails() {
            const estratos = [1, 2, 3, 4, 5];
            return estratos.map(estrato => ({
                estrato: estrato,
                total: Math.floor(Math.random() * 20 + 5),
                optimizados: Math.floor(Math.random() * 15 + 3),
                tasaExito: (Math.random() * 40 + 60).toFixed(1),
                reduccionPromedio: (Math.random() * 25 + 15).toFixed(2)
            }));
        }

        // Generar top optimizaciones
        function generateTopOptimizations(count) {
            const gadNames = [
                'G.A.D. MUNICIPAL DE QUITO',
                'G.A.D. MUNICIPAL DE GUAYAQUIL',
                'G.A.D. MUNICIPAL DE CUENCA',
                'G.A.D. PROVINCIAL DE PICHINCHA',
                'G.A.D. PROVINCIAL DE GUAYAS',
                'G.A.D. MUNICIPAL DE AMBATO',
                'G.A.D. MUNICIPAL DE MACHALA',
                'G.A.D. MUNICIPAL DE SANTO DOMINGO'
            ];

            return Array.from({length: count}, (_, i) => ({
                gad: gadNames[i % gadNames.length],
                percVpOriginal: (Math.random() * 0.2 + 0.25).toFixed(4),
                percVpOptimo: (Math.random() * 0.15 + 0.05).toFixed(4),
                reduccion: (Math.random() * 40 + 20).toFixed(2),
                estrato: Math.floor(Math.random() * 5) + 1
            }));
        }

        // Mostrar resultados de optimizaci√≥n
        function displayOptimizationResults(results) {
            const container = document.getElementById('optimization-results');

            const html = `
                <div class="alert alert-success">
                    üéâ Optimizaci√≥n completada: ${results.optimizados}/${results.totalProcesados} GADs optimizados (${results.tasaExito}% de √©xito)
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <h4>üìä Resumen Ejecutivo</h4>
                        <div class="metric">
                            <span>GADs Procesados:</span>
                            <span class="metric-value">${results.totalProcesados}</span>
                        </div>
                        <div class="metric">
                            <span>GADs Optimizados:</span>
                            <span class="metric-value">${results.optimizados}</span>
                        </div>
                        <div class="metric">
                            <span>Tasa de √âxito:</span>
                            <span class="metric-value">${results.tasaExito}%</span>
                        </div>
                        <div class="metric">
                            <span>Reducci√≥n Promedio:</span>
                            <span class="metric-value">${results.reduccionPromedio}%</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h4>üèõÔ∏è Resultados por Estrato</h4>
                        ${results.detallesPorEstrato.map(estrato => `
                            <div class="metric">
                                <span>Estrato ${estrato.estrato}:</span>
                                <span class="metric-value">${estrato.optimizados}/${estrato.total} (${estrato.tasaExito}%)</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="result-card" style="margin-top: 20px;">
                    <h4>üèÜ Top 5 Optimizaciones</h4>
                    ${results.topOptimizaciones.map((opt, index) => `
                        <div class="gad-item">
                            <div class="gad-info">
                                <h5>${index + 1}. ${opt.gad}</h5>
                                <p>perc_vp: ${opt.percVpOriginal} ‚Üí ${opt.percVpOptimo} | Estrato: ${opt.estrato}</p>
                            </div>
                            <div class="gad-status status-optimized">
                                -${opt.reduccion}%
                            </div>
                        </div>
                    `).join('')}
                </div>

                ${results.gadsProblematicosRestantes > 0 ? `
                    <div class="alert alert-warning" style="margin-top: 20px;">
                        ‚ö†Ô∏è ${results.gadsProblematicosRestantes} GADs requieren atenci√≥n manual adicional
                    </div>
                ` : ''}
            `;

            container.innerHTML = html;
            showTab('results');
        }

        // Cambiar pesta√±a
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Activar bot√≥n correspondiente
            event?.target?.classList.add('active');
        }

        // Actualizar paso en el indicador
        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }

        // Mostrar mensaje de carga
        function showLoading(message) {
            // Implementar overlay de carga si es necesario
            console.log(`Loading: ${message}`);
        }

        // Mostrar alerta
        function showAlert(message, type) {
            // Crear elemento de alerta temporal
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.maxWidth = '400px';
            alert.style.animation = 'slideInRight 0.3s ease';

            document.body.appendChild(alert);

            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                alert.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 5000);
        }

        // Agregar mensaje al log
        function logMessage(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logContent.textContent += logEntry;
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Descargar reporte
        function downloadReport() {
            if (!systemState.optimizationResults) {
                showAlert('No hay resultados para descargar', 'warning');
                return;
            }

            // Simular descarga de reporte
            showAlert('üìÑ Generando reporte Excel...', 'success');
            
            // En implementaci√≥n real, generar√≠as y descargar√≠as el archivo Excel
            setTimeout(() => {
                showAlert('‚úÖ Reporte descargado: Optimizacion_Cupos_GAD.xlsx', 'success');
            }, 2000);
        }

        // Reiniciar sistema
        function resetSystem() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar el sistema? Se perder√°n todos los datos cargados.')) {
                location.reload();
            }
        }

        // Mostrar ayuda
        function showHelp() {
            const helpContent = `
                üèõÔ∏è SISTEMA DE OPTIMIZACI√ìN DE CUPOS GAD

                üìã PASOS PARA USAR EL SISTEMA:

                1Ô∏è‚É£ CARGAR DATOS:
                   ‚Ä¢ Sube las 4 bases de datos requeridas
                   ‚Ä¢ Formatos soportados: Excel (.xlsx), CSV (.csv)
                   ‚Ä¢ Verifica que tengan las columnas requeridas

                2Ô∏è‚É£ VALIDAR:
                   ‚Ä¢ El sistema verifica la integridad de los datos
                   ‚Ä¢ Revisa errores y advertencias
                   ‚Ä¢ Confirma que los datos son consistentes

                3Ô∏è‚É£ PROCESAR:
                   ‚Ä¢ Configura par√°metros de optimizaci√≥n
                   ‚Ä¢ Selecciona estrategia (autom√°tica recomendada)
                   ‚Ä¢ Ajusta precisi√≥n seg√∫n necesidades

                4Ô∏è‚É£ OPTIMIZAR:
                   ‚Ä¢ El sistema encuentra valores √≥ptimos de perc_vp
                   ‚Ä¢ Aplica restricciones COPLAFIP autom√°ticamente
                   ‚Ä¢ Genera reporte de resultados

                5Ô∏è‚É£ REPORTES:
                   ‚Ä¢ Descarga resultados en Excel
                   ‚Ä¢ Revisa estad√≠sticas por estrato
                   ‚Ä¢ Identifica GADs que requieren atenci√≥n

                ‚ùì BASES DE DATOS REQUERIDAS:

                üìä Datos Completos de Gastos:
                   ‚Ä¢ Columnas: gad, anho, ing_pred, g1_pred, g2_pred, est1
                   ‚Ä¢ Proyecciones financieras de GADs

                üìà Rankings AT:
                   ‚Ä¢ Columnas: gad, DECIL
                   ‚Ä¢ Rankings de desempe√±o

                ‚öñÔ∏è Modelo de Equidad Municipal:
                   ‚Ä¢ Columnas: gad
                   ‚Ä¢ Datos del MEF

                üí≥ Datos de Deuda:
                   ‚Ä¢ Columnas: gad, anho, serv_deuda_total, deuda_total
                   ‚Ä¢ Informaci√≥n de endeudamiento

                üéØ CONSEJOS:
                   ‚Ä¢ Usa precisi√≥n 0.01 para mejores resultados
                   ‚Ä¢ Revisa advertencias en la validaci√≥n
                   ‚Ä¢ Estrategia autom√°tica es la recomendada
                   ‚Ä¢ Los resultados se pueden exportar a Excel

                üìû SOPORTE:
                   Para ayuda adicional, contacta al equipo t√©cnico.
            `;

            alert(helpContent);
        }

        // Animaciones CSS adicionales
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            logMessage('üöÄ Sistema de Optimizaci√≥n de Cupos GAD iniciado');
            logMessage('üìã Esperando carga de bases de datos...');
        });
    </script>
</body>
</html>
